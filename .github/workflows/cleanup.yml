name: Cleanup

on:
  schedule:
    # æ¯æ—¥åˆå‰2æ™‚ï¼ˆUTCï¼‰ã«å®Ÿè¡Œ
    - cron: '0 2 * * *'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  cleanup-worktrees:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Configure Git
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
    
    - name: Cleanup old worktrees (dry run)
      run: |
        python scripts/auto_cleanup.py --days 14 --dry-run --branches
    
    - name: Cleanup old worktrees
      run: |
        python scripts/auto_cleanup.py --days 14 --branches
    
    - name: Prune remote branches
      run: |
        git remote prune origin
    
    - name: Report cleanup results
      run: |
        echo "ğŸ§¹ Cleanup completed"
        git worktree list
        git branch -a | grep -E "(feature/|hotfix/)" | wc -l || echo "0 feature branches remaining"
