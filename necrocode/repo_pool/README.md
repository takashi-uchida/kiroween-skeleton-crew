# Repo Pool Manager

**ğŸš€ Git Worktreeã§å¼·åŒ– - 10å€é«˜é€Ÿãªå‰²ã‚Šå½“ã¦ã€90%ã®ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡å‰Šæ¸›ï¼**

Repo Pool Managerã¯ã€NecroCodeã‚·ã‚¹ãƒ†ãƒ ã«ãŠã„ã¦ä¸¦åˆ—ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Ÿè¡Œã®ãŸã‚ã®è¤‡æ•°ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚¹ãƒ­ãƒƒãƒˆã‚’ç®¡ç†ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã™ã€‚**git worktree**ã‚’ä½¿ç”¨ã—ã¦ã€åŠ¹ç‡çš„ãªå‰²ã‚Šå½“ã¦ã€ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã€ç›£è¦–ã‚’æä¾›ã—ã¾ã™ã€‚

## æ¦‚è¦

Repo Pool Managerã¯ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã«å‰²ã‚Šå½“ã¦å¯èƒ½ãªäº‹å‰ã‚¯ãƒ­ãƒ¼ãƒ³ã•ã‚ŒãŸgitãƒªãƒã‚¸ãƒˆãƒªï¼ˆã‚¹ãƒ­ãƒƒãƒˆï¼‰ã®ãƒ—ãƒ¼ãƒ«ã‚’ç¶­æŒã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€å„ã‚¿ã‚¹ã‚¯ã”ã¨ã«ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã™ã‚‹ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒæ’é™¤ã•ã‚Œã€ä¸¦åˆ—å®Ÿè¡ŒãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

## ä¸»ãªæ©Ÿèƒ½

- **Git Worktreeãƒ™ãƒ¼ã‚¹**: åŠ¹ç‡çš„ãªä¸¦åˆ—å®Ÿè¡Œã®ãŸã‚ã«git worktreeã‚’ä½¿ç”¨
- **10å€é«˜é€Ÿãªå‰²ã‚Šå½“ã¦**: 1ç§’æœªæº€ã§ã‚¹ãƒ­ãƒƒãƒˆä½œæˆï¼ˆã‚¯ãƒ­ãƒ¼ãƒ³ã®10-30ç§’ã¨æ¯”è¼ƒï¼‰
- **90%ã®ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡å‰Šæ¸›**: å…¨ã‚¹ãƒ­ãƒƒãƒˆé–“ã§.gitãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å…±æœ‰
- **ãƒ—ãƒ¼ãƒ«ç®¡ç†**: ãƒªãƒã‚¸ãƒˆãƒªworktreeã®ãƒ—ãƒ¼ãƒ«ã‚’ä½œæˆãƒ»ç®¡ç†
- **ã‚¹ãƒ­ãƒƒãƒˆå‰²ã‚Šå½“ã¦**: æœ€é©ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ãŸã‚ã®LRUãƒ™ãƒ¼ã‚¹å‰²ã‚Šå½“ã¦æˆ¦ç•¥
- **è‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—**: å‰²ã‚Šå½“ã¦å‰å¾Œã®Gitæ“ä½œï¼ˆfetchã€cleanã€resetï¼‰
- **ä¸¦è¡Œåˆ¶å¾¡**: ãƒ•ã‚¡ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹ã®ãƒ­ãƒƒã‚¯ã§äºŒé‡å‰²ã‚Šå½“ã¦ã‚’é˜²æ­¢
- **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç›£è¦–**: ã‚¹ãƒ­ãƒƒãƒˆçŠ¶æ…‹ã€ä½¿ç”¨çµ±è¨ˆã€ãƒ—ãƒ¼ãƒ«ãƒ˜ãƒ«ã‚¹ã‚’è¿½è·¡
- **å‹•çš„ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°**: å®Ÿè¡Œæ™‚ã«ã‚¹ãƒ­ãƒƒãƒˆã‚’è¿½åŠ ãƒ»å‰Šé™¤
- **100% APIäº’æ›**: ã‚¯ãƒ­ãƒ¼ãƒ³ãƒ™ãƒ¼ã‚¹å®Ÿè£…ã®ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ³ç½®æ›

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
PoolManager (ãƒ¡ã‚¤ãƒ³API)
    â”œâ”€â”€ SlotStore (æ°¸ç¶šåŒ–)
    â”œâ”€â”€ SlotAllocator (å‰²ã‚Šå½“ã¦æˆ¦ç•¥)
    â”œâ”€â”€ SlotCleaner (ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—æ“ä½œ)
    â”œâ”€â”€ GitOperations (Gitã‚³ãƒãƒ³ãƒ‰)
    â””â”€â”€ LockManager (ä¸¦è¡Œåˆ¶å¾¡)
```

## ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ

```python
from necrocode.repo_pool import PoolManager, PoolConfig
from pathlib import Path

# PoolManagerã‚’åˆæœŸåŒ–
config = PoolConfig(
    workspaces_dir=Path.home() / ".necrocode" / "workspaces",
    lock_timeout=30.0,
)
manager = PoolManager(config)

# 3ã¤ã®ã‚¹ãƒ­ãƒƒãƒˆã‚’æŒã¤ãƒ—ãƒ¼ãƒ«ã‚’ä½œæˆ
pool = manager.create_pool(
    repo_name="my-project",
    repo_url="https://github.com/user/my-project.git",
    num_slots=3
)

# ã‚¹ãƒ­ãƒƒãƒˆã‚’å‰²ã‚Šå½“ã¦
slot = manager.allocate_slot("my-project")
print(f"å‰²ã‚Šå½“ã¦æ¸ˆã¿: {slot.slot_id}")
print(f"ãƒ‘ã‚¹: {slot.slot_path}")

# ã‚¹ãƒ­ãƒƒãƒˆã§ä½œæ¥­ã‚’å®Ÿè¡Œ...
# (Gitæ“ä½œã€ãƒ†ã‚¹ãƒˆå®Ÿè¡Œãªã©)

# å®Œäº†ã—ãŸã‚‰ã‚¹ãƒ­ãƒƒãƒˆã‚’è§£æ”¾
manager.release_slot(slot.slot_id)
```

## APIãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹

### PoolManager

ãƒ—ãƒ¼ãƒ«ã¨ã‚¹ãƒ­ãƒƒãƒˆç®¡ç†ã®ãƒ¡ã‚¤ãƒ³APIã‚¯ãƒ©ã‚¹ã§ã™ã€‚

#### ãƒ—ãƒ¼ãƒ«ç®¡ç†

```python
# æ–°ã—ã„ãƒ—ãƒ¼ãƒ«ã‚’ä½œæˆ
pool = manager.create_pool(
    repo_name="my-project",
    repo_url="https://github.com/user/my-project.git",
    num_slots=3
)

# æ—¢å­˜ã®ãƒ—ãƒ¼ãƒ«ã‚’å–å¾—
pool = manager.get_pool("my-project")

# å…¨ãƒ—ãƒ¼ãƒ«ã‚’ãƒªã‚¹ãƒˆ
pools = manager.list_pools()  # æˆ»ã‚Šå€¤: ["my-project", "other-project"]
```

#### ã‚¹ãƒ­ãƒƒãƒˆå‰²ã‚Šå½“ã¦

```python
# ã‚¹ãƒ­ãƒƒãƒˆã‚’å‰²ã‚Šå½“ã¦ï¼ˆè‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä»˜ãï¼‰
slot = manager.allocate_slot("my-project", metadata={"task_id": "123"})

# ã‚¹ãƒ­ãƒƒãƒˆã‚’è§£æ”¾ï¼ˆè‡ªå‹•ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä»˜ãï¼‰
manager.release_slot(slot.slot_id)

# ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãªã—ã§è§£æ”¾ï¼ˆé«˜é€Ÿã ãŒå®‰å…¨æ€§ã¯ä½ã„ï¼‰
manager.release_slot(slot.slot_id, cleanup=False)
```

#### ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç›£è¦–

```python
# è©³ç´°ãªã‚¹ãƒ­ãƒƒãƒˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—
status = manager.get_slot_status(slot.slot_id)
print(f"çŠ¶æ…‹: {status.state.value}")
print(f"ãƒ­ãƒƒã‚¯ä¸­: {status.is_locked}")
print(f"å‰²ã‚Šå½“ã¦å›æ•°: {status.allocation_count}")
print(f"ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨é‡: {status.disk_usage_mb:.2f} MB")

# å…¨ãƒ—ãƒ¼ãƒ«ã®ã‚µãƒãƒªãƒ¼ã‚’å–å¾—
summary = manager.get_pool_summary()
for repo_name, pool_summary in summary.items():
    print(f"ãƒ—ãƒ¼ãƒ«: {repo_name}")
    print(f"  ç·ã‚¹ãƒ­ãƒƒãƒˆæ•°: {pool_summary.total_slots}")
    print(f"  åˆ©ç”¨å¯èƒ½: {pool_summary.available_slots}")
    print(f"  å‰²ã‚Šå½“ã¦æ¸ˆã¿: {pool_summary.allocated_slots}")
```

#### å‹•çš„ã‚¹ãƒ­ãƒƒãƒˆç®¡ç†

```python
# æ—¢å­˜ã®ãƒ—ãƒ¼ãƒ«ã«æ–°ã—ã„ã‚¹ãƒ­ãƒƒãƒˆã‚’è¿½åŠ 
new_slot = manager.add_slot("my-project")

# ã‚¹ãƒ­ãƒƒãƒˆã‚’å‰Šé™¤ï¼ˆå‰²ã‚Šå½“ã¦æ¸ˆã¿ã§ãªã„ã“ã¨ï¼‰
manager.remove_slot(slot.slot_id)

# å¼·åˆ¶å‰Šé™¤ï¼ˆå‰²ã‚Šå½“ã¦æ¸ˆã¿ã§ã‚‚å‰Šé™¤ï¼‰
manager.remove_slot(slot.slot_id, force=True)
```

## ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

### Slot

å˜ä¸€ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚¹ãƒ­ãƒƒãƒˆã‚’è¡¨ã—ã¾ã™ã€‚

```python
@dataclass
class Slot:
    slot_id: str                    # "workspace-my-project-slot1"
    repo_name: str                  # "my-project"
    repo_url: str                   # ãƒªãƒã‚¸ãƒˆãƒªURL
    slot_path: Path                 # ã‚¹ãƒ­ãƒƒãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ã®ãƒ‘ã‚¹
    state: SlotState                # AVAILABLE, ALLOCATED, CLEANING, ERROR
    
    # ä½¿ç”¨çµ±è¨ˆ
    allocation_count: int
    total_usage_seconds: int
    last_allocated_at: Optional[datetime]
    last_released_at: Optional[datetime]
    
    # Gitæƒ…å ±
    current_branch: Optional[str]
    current_commit: Optional[str]
```

### SlotState

ã‚¹ãƒ­ãƒƒãƒˆçŠ¶æ…‹ã‚’è¡¨ã™åˆ—æŒ™å‹ï¼š

- `AVAILABLE`: å‰²ã‚Šå½“ã¦å¯èƒ½
- `ALLOCATED`: ä½¿ç”¨ä¸­
- `CLEANING`: ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­
- `ERROR`: ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã€ä¿®å¾©ãŒå¿…è¦

### Pool

ãƒªãƒã‚¸ãƒˆãƒªã®ã‚¹ãƒ­ãƒƒãƒˆãƒ—ãƒ¼ãƒ«ã‚’è¡¨ã—ã¾ã™ã€‚

```python
@dataclass
class Pool:
    repo_name: str
    repo_url: str
    num_slots: int
    slots: List[Slot]
    created_at: datetime
    updated_at: datetime
```

## ãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ 

```
~/.necrocode/workspaces/
â”œâ”€â”€ my-project/
â”‚   â”œâ”€â”€ pool.json              # ãƒ—ãƒ¼ãƒ«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
â”‚   â”œâ”€â”€ slot1/
â”‚   â”‚   â”œâ”€â”€ .git/              # Gitãƒªãƒã‚¸ãƒˆãƒª
â”‚   â”‚   â”œâ”€â”€ slot.json          # ã‚¹ãƒ­ãƒƒãƒˆãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
â”‚   â”‚   â””â”€â”€ ...                # ãƒªãƒã‚¸ãƒˆãƒªãƒ•ã‚¡ã‚¤ãƒ«
â”‚   â”œâ”€â”€ slot2/
â”‚   â””â”€â”€ slot3/
â”œâ”€â”€ other-project/
â”‚   â”œâ”€â”€ pool.json
â”‚   â”œâ”€â”€ slot1/
â”‚   â””â”€â”€ slot2/
â””â”€â”€ locks/
    â”œâ”€â”€ workspace-my-project-slot1.lock
    â””â”€â”€ workspace-my-project-slot2.lock
```

## è¨­å®š

### è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

```python
@dataclass
class PoolConfig:
    workspaces_dir: Path = Path.home() / ".necrocode" / "workspaces"
    config_file: Path = Path.home() / ".necrocode" / "config" / "pools.yaml"
    default_num_slots: int = 2
    lock_timeout: float = 30.0
    cleanup_timeout: float = 60.0
    stale_lock_hours: int = 24
    enable_metrics: bool = True
```

### YAMLè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«

Repo Pool Managerã¯ã€ç®¡ç†ã¨ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å®¹æ˜“ã«ã™ã‚‹ãŸã‚ã«YAMLãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã®è¨­å®šèª­ã¿è¾¼ã¿ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã™ã€‚

#### è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼

`~/.necrocode/config/pools.yaml`ã«`pools.yaml`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ï¼š

```yaml
# å…¨ãƒ—ãƒ¼ãƒ«ã«é©ç”¨ã•ã‚Œã‚‹ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
defaults:
  num_slots: 2
  lock_timeout: 30.0
  cleanup_timeout: 60.0
  stale_lock_hours: 24
  enable_metrics: true

# ãƒ—ãƒ¼ãƒ«å®šç¾©
pools:
  my-project:
    repo_url: https://github.com/user/my-project.git
    num_slots: 3
    cleanup_options:
      fetch_on_allocate: true
      clean_on_release: true
      warmup_enabled: false
  
  another-project:
    repo_url: https://github.com/user/another-project.git
    num_slots: 2
    cleanup_options:
      fetch_on_allocate: true
      clean_on_release: true
      warmup_enabled: true
```

#### è¨­å®šã®èª­ã¿è¾¼ã¿

```python
from necrocode.repo_pool import PoolManager, PoolConfig
from pathlib import Path

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å ´æ‰€ã‹ã‚‰èª­ã¿è¾¼ã¿ (~/.necrocode/config/pools.yaml)
config = PoolConfig.load_from_file()

# ã‚«ã‚¹ã‚¿ãƒ ã®å ´æ‰€ã‹ã‚‰èª­ã¿è¾¼ã¿
config = PoolConfig.load_from_file(Path("custom/pools.yaml"))

# è¨­å®šã‚’æ¤œè¨¼
config.validate()

# èª­ã¿è¾¼ã‚“ã è¨­å®šã§PoolManagerã‚’ä½œæˆ
manager = PoolManager(config)
```

#### ãƒ—ãƒ¼ãƒ«ã®è‡ªå‹•åˆæœŸåŒ–

è¨­å®šã§å®šç¾©ã•ã‚ŒãŸå…¨ãƒ—ãƒ¼ãƒ«ã‚’è‡ªå‹•çš„ã«ä½œæˆï¼š

```python
# PoolManagerã‚’ä½œæˆã—ã¦ãƒ—ãƒ¼ãƒ«ã‚’è‡ªå‹•åˆæœŸåŒ–
manager = PoolManager.from_config_file(auto_init_pools=True)

# ã¾ãŸã¯ä½œæˆå¾Œã«æ‰‹å‹•ã§åˆæœŸåŒ–
manager = PoolManager(config)
created_pools = manager.initialize_pools_from_config()
```

#### å‹•çš„ãªè¨­å®šãƒªãƒ­ãƒ¼ãƒ‰

å†èµ·å‹•ã›ãšã«å®Ÿè¡Œæ™‚ã«è¨­å®šã‚’ãƒªãƒ­ãƒ¼ãƒ‰ï¼š

```python
# ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰è¨­å®šã‚’ãƒªãƒ­ãƒ¼ãƒ‰
manager.reload_config()

# ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒªãƒ­ãƒ¼ãƒ‰
manager.reload_config(Path("custom/pools.yaml"))
```

#### è¨­å®šã‚¦ã‚©ãƒƒãƒãƒ£ãƒ¼

è¨­å®šå¤‰æ›´ã‚’è‡ªå‹•çš„ã«æ¤œå‡ºã—ã¦é©ç”¨ï¼š

```python
from necrocode.repo_pool.config import ConfigWatcher

# ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ä»˜ãã§ã‚¦ã‚©ãƒƒãƒãƒ£ãƒ¼ã‚’ä½œæˆ
def on_config_change(new_config):
    print(f"è¨­å®šãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ: {len(new_config.pools)} ãƒ—ãƒ¼ãƒ«")
    manager.reload_config()

watcher = ConfigWatcher(config, on_change=on_config_change)

# å®šæœŸçš„ã«å¤‰æ›´ã‚’ãƒã‚§ãƒƒã‚¯
while True:
    watcher.check_and_reload()
    time.sleep(60)  # 1åˆ†ã”ã¨ã«ãƒã‚§ãƒƒã‚¯
```

#### è¨­å®šã®ä¿å­˜

ç¾åœ¨ã®è¨­å®šã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼š

```python
# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å ´æ‰€ã«ä¿å­˜
config.save_to_file()

# ã‚«ã‚¹ã‚¿ãƒ ã®å ´æ‰€ã«ä¿å­˜
config.save_to_file(Path("backup/pools.yaml"))
```

#### è¨­å®šã®æ¤œè¨¼

è¨­å®šã‚·ã‚¹ãƒ†ãƒ ã¯ä»¥ä¸‹ã‚’æ¤œè¨¼ã—ã¾ã™ï¼š
- æ•°å€¤ç¯„å›²ï¼ˆnum_slots >= 1ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ > 0ï¼‰
- å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆrepo_urlãŒå­˜åœ¨ã™ã‚‹ã“ã¨ï¼‰
- ãƒ—ãƒ¼ãƒ«å›ºæœ‰ã®è¨­å®š

```python
from necrocode.repo_pool.config import ConfigValidationError

try:
    config.validate()
except ConfigValidationError as e:
    print(f"ç„¡åŠ¹ãªè¨­å®š: {e}")
```

## ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—æ“ä½œ

PoolManagerã¯è‡ªå‹•çš„ã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—æ“ä½œã‚’å®Ÿè¡Œã—ã¾ã™ï¼š

### å‰²ã‚Šå½“ã¦å‰
1. `git fetch --all` - ãƒªãƒ¢ãƒ¼ãƒˆå‚ç…§ã‚’æ›´æ–°
2. `git clean -fdx` - è¿½è·¡ã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
3. `git reset --hard` - ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒªã‚»ãƒƒãƒˆ

### è§£æ”¾å¾Œ
å‰²ã‚Šå½“ã¦å‰ã¨åŒã˜æ“ä½œã‚’å®Ÿè¡Œã—ã€æ¬¡ã®ä½¿ç”¨ã®ãŸã‚ã«ã‚¹ãƒ­ãƒƒãƒˆã‚’ã‚¯ãƒªãƒ¼ãƒ³ãªçŠ¶æ…‹ã«ã—ã¾ã™ã€‚

## ä¸¦è¡Œåˆ¶å¾¡

PoolManagerã¯ãƒ•ã‚¡ã‚¤ãƒ«ãƒ™ãƒ¼ã‚¹ã®ãƒ­ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¦ã€åŒã˜ã‚¹ãƒ­ãƒƒãƒˆã¸ã®ä¸¦è¡Œã‚¢ã‚¯ã‚»ã‚¹ã‚’é˜²æ­¢ã—ã¾ã™ï¼š

```python
# ãƒ­ãƒƒã‚¯ã¯è‡ªå‹•çš„ã«å–å¾—/è§£æ”¾ã•ã‚Œã¾ã™
with lock_manager.acquire_slot_lock(slot_id, timeout=30.0):
    # ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ - ã‚¹ãƒ­ãƒƒãƒˆã¯ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™
    allocate_slot()
```

### å¤ã„ãƒ­ãƒƒã‚¯ã®æ¤œå‡º

```python
# 24æ™‚é–“ä»¥ä¸Šå¤ã„ãƒ­ãƒƒã‚¯ã‚’æ¤œå‡º
stale_locks = lock_manager.detect_stale_locks(max_age_hours=24)

# å¤ã„ãƒ­ãƒƒã‚¯ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
cleaned = lock_manager.cleanup_stale_locks(max_age_hours=24)
```

## ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒªã‚«ãƒãƒªãƒ¼

### ä¾‹å¤–å‡¦ç†

```python
from necrocode.repo_pool import (
    PoolNotFoundError,
    SlotNotFoundError,
    NoAvailableSlotError,
    SlotAllocationError,
    LockTimeoutError,
)

try:
    slot = manager.allocate_slot("my-project")
except PoolNotFoundError:
    print("ãƒ—ãƒ¼ãƒ«ãŒå­˜åœ¨ã—ã¾ã›ã‚“")
except NoAvailableSlotError:
    print("å…¨ã¦ã®ã‚¹ãƒ­ãƒƒãƒˆãŒç¾åœ¨å‰²ã‚Šå½“ã¦æ¸ˆã¿ã§ã™")
except LockTimeoutError:
    print("ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå†…ã«ãƒ­ãƒƒã‚¯ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ")
except SlotAllocationError as e:
    print(f"å‰²ã‚Šå½“ã¦ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")
```

### ç•°å¸¸æ¤œå‡º

æ§˜ã€…ãªã‚·ã‚¹ãƒ†ãƒ ç•°å¸¸ã‚’æ¤œå‡ºã—ã¦å‡¦ç†ï¼š

```python
# å…¨ã¦ã®ç•°å¸¸ã‚’æ¤œå‡º
anomalies = manager.detect_anomalies(max_allocation_hours=24)

# ç‰¹å®šã®ç•°å¸¸ã‚¿ã‚¤ãƒ—ã‚’ãƒã‚§ãƒƒã‚¯
long_allocated = manager.detect_long_allocated_slots(max_allocation_hours=24)
corrupted = manager.detect_corrupted_slots()
orphaned_locks = manager.detect_orphaned_locks()
```

### è‡ªå‹•ãƒªã‚«ãƒãƒªãƒ¼

æ¤œå‡ºã•ã‚ŒãŸå•é¡Œã‹ã‚‰è‡ªå‹•çš„ã«ãƒªã‚«ãƒãƒªãƒ¼ï¼š

```python
# è‡ªå‹•ãƒªã‚«ãƒãƒªãƒ¼ã‚’å®Ÿè¡Œ
results = manager.auto_recover(
    max_allocation_hours=24,
    recover_corrupted=True,
    cleanup_orphaned_locks=True,
    force_release_long_allocated=False
)

print(f"è§£æ”¾: {results['long_allocated_released']}")
print(f"ãƒªã‚«ãƒãƒªãƒ¼: {results['corrupted_recovered']}")
print(f"éš”é›¢: {results['corrupted_isolated']}")
print(f"ãƒ­ãƒƒã‚¯ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—: {results['orphaned_locks_cleaned']}")
```

### æ‰‹å‹•ãƒªã‚«ãƒãƒªãƒ¼

å€‹åˆ¥ã®ã‚¹ãƒ­ãƒƒãƒˆã‚’ãƒªã‚«ãƒãƒªãƒ¼ï¼š

```python
# ç ´æã—ãŸã‚¹ãƒ­ãƒƒãƒˆã®ãƒªã‚«ãƒãƒªãƒ¼ã‚’è©¦è¡Œ
success = manager.recover_slot(slot_id, force=False)

# å•é¡Œã®ã‚ã‚‹ã‚¹ãƒ­ãƒƒãƒˆã‚’éš”é›¢
manager.isolate_slot(slot_id)
```

ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒªã‚«ãƒãƒªãƒ¼ã®è©³ç´°ã«ã¤ã„ã¦ã¯ã€[ERROR_RECOVERY_GUIDE.md](ERROR_RECOVERY_GUIDE.md)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### LRUã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

SlotAllocatorã¯LRUï¼ˆLeast Recently Usedï¼‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ç”¨ã—ã¦ã€æœ€è¿‘ä½¿ç”¨ã•ã‚ŒãŸã‚¹ãƒ­ãƒƒãƒˆã‚’å„ªå…ˆã—ã¾ã™ï¼š

```python
# å‰²ã‚Šå½“ã¦ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’å–å¾—
metrics = slot_allocator.get_allocation_metrics("my-project")
print(f"ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡: {metrics.cache_hit_rate:.2%}")
print(f"å¹³å‡å‰²ã‚Šå½“ã¦æ™‚é–“: {metrics.average_allocation_time_seconds:.2f}ç§’")
```

### ã‚¹ãƒ­ãƒƒãƒˆã®ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—

ã‚ˆã‚Šé«˜é€Ÿãªå‰²ã‚Šå½“ã¦ã®ãŸã‚ã«ã‚¹ãƒ­ãƒƒãƒˆã‚’äº‹å‰ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—ï¼š

```python
# ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—ã¯git fetchã¨æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
result = slot_cleaner.warmup_slot(slot)
```

## NecroCodeã¨ã®çµ±åˆ

Repo Pool Managerã¯ä»–ã®NecroCodeã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¨çµ±åˆã•ã‚Œã¾ã™ï¼š

- **Agent Runner**: ã‚¿ã‚¹ã‚¯å®Ÿè¡Œã®ãŸã‚ã«ã‚¹ãƒ­ãƒƒãƒˆã‚’è¦æ±‚
- **Dispatcher**: è¤‡æ•°ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–“ã§ã‚¹ãƒ­ãƒƒãƒˆå‰²ã‚Šå½“ã¦ã‚’èª¿æ•´
- **Workspace Manager**: ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹æ“ä½œã®ãƒ™ãƒ¼ã‚¹ã¨ã—ã¦ã‚¹ãƒ­ãƒƒãƒˆã‚’ä½¿ç”¨

## ä½¿ç”¨ä¾‹

å®Œå…¨ãªä½¿ç”¨ä¾‹ã«ã¤ã„ã¦ã¯ã€`examples/pool_manager_example.py`ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

## è¦ä»¶

- Python 3.11ä»¥ä¸Š
- Git CLI
- filelockãƒ©ã‚¤ãƒ–ãƒ©ãƒª

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [ã‚¨ãƒ©ãƒ¼ãƒªã‚«ãƒãƒªãƒ¼ã‚¬ã‚¤ãƒ‰](ERROR_RECOVERY_GUIDE.md) - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒªã‚«ãƒãƒªãƒ¼ã®åŒ…æ‹¬çš„ãªã‚¬ã‚¤ãƒ‰
- [è¨­å®šã‚¬ã‚¤ãƒ‰](CONFIG_GUIDE.md) - è©³ç´°ãªè¨­å®šãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- [è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](../../.kiro/specs/repo-pool-manager/design.md)
- [è¦ä»¶](../../.kiro/specs/repo-pool-manager/requirements.md)
- [ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆ](../../.kiro/specs/repo-pool-manager/tasks.md)
- [ä½¿ç”¨ä¾‹](../../examples/) - ã‚¨ãƒ©ãƒ¼ãƒªã‚«ãƒãƒªãƒ¼ã‚’å«ã‚€ä½¿ç”¨ä¾‹
