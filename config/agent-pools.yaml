# Agent Pools Configuration
#
# このファイルは、Dispatcherが管理するAgent Poolの設定を定義します。
# 各Agent Poolは、Agent Runnerを起動する環境を表します。

# Agent Pool定義
agent_pools:
  # ローカルプロセスプール
  # 開発環境やテスト用に使用
  local:
    # プールタイプ: local-process, docker, kubernetes
    type: local-process
    
    # 最大同時実行数
    max_concurrency: 2
    
    # プールを有効化
    enabled: true
    
    # プール固有の設定
    config:
      # Pythonインタープリタのパス
      python_path: /usr/bin/python3
      
      # 作業ディレクトリ
      working_dir: /tmp/necrocode/local
      
      # 環境変数
      environment:
        NECROCODE_POOL: local
        LOG_LEVEL: DEBUG
  
  # Dockerプール
  # 本番環境での標準的な実行環境
  docker:
    type: docker
    max_concurrency: 5
    
    # リソースクォータ
    cpu_quota: 8  # CPUコア数
    memory_quota: 16384  # MB (16GB)
    
    enabled: true
    
    config:
      # Dockerイメージ
      image: necrocode/runner:latest
      
      # イメージプルポリシー: always, if-not-present, never
      pull_policy: if-not-present
      
      # Repo Poolをマウント
      mount_repo_pool: true
      
      # Dockerネットワーク
      network: necrocode-network
      
      # ボリュームマウント
      volumes:
        /var/run/docker.sock: /var/run/docker.sock
        /tmp/necrocode/cache: /cache
      
      # 環境変数
      environment:
        NECROCODE_POOL: docker
        NECROCODE_ENV: production
        LOG_LEVEL: INFO
        DOCKER_HOST: unix:///var/run/docker.sock
      
      # リソース制限
      resources:
        cpu_limit: 2.0  # タスクあたりのCPU制限
        memory_limit: 4096  # タスクあたりのメモリ制限（MB）
        
      # ラベル
      labels:
        app: necrocode
        component: agent-runner
        pool: docker
  
  # GPU対応Dockerプール
  # 機械学習タスク用
  docker-gpu:
    type: docker
    max_concurrency: 2
    cpu_quota: 16
    memory_quota: 32768  # 32GB
    enabled: true
    
    config:
      image: necrocode/runner:gpu
      pull_policy: if-not-present
      mount_repo_pool: true
      
      # NVIDIAランタイムを使用
      runtime: nvidia
      
      # すべてのGPUを使用
      gpus: all
      
      environment:
        NECROCODE_POOL: docker-gpu
        CUDA_VISIBLE_DEVICES: "0,1"
        NVIDIA_VISIBLE_DEVICES: all
        NVIDIA_DRIVER_CAPABILITIES: compute,utility
      
      resources:
        cpu_limit: 8.0
        memory_limit: 16384
        
      labels:
        app: necrocode
        component: agent-runner
        pool: docker-gpu
        gpu: "true"
  
  # Kubernetesプール
  # 大規模な本番環境用
  k8s:
    type: kubernetes
    max_concurrency: 10
    cpu_quota: 20
    memory_quota: 40960  # 40GB
    enabled: true
    
    config:
      # Kubernetesネームスペース
      namespace: necrocode-agents
      
      # Jobテンプレートファイル
      job_template: manifests/runner-job.yaml
      
      # サービスアカウント
      service_account: necrocode-runner
      
      # イメージプルシークレット
      image_pull_secrets:
        - necrocode-registry
      
      # ノードセレクター
      node_selector:
        workload: necrocode
        instance-type: on-demand
      
      # Tolerations
      tolerations:
        - key: necrocode
          operator: Equal
          value: "true"
          effect: NoSchedule
      
      # リソース要求と制限
      resources:
        requests:
          cpu: 1.0
          memory: 2048  # MB
        limits:
          cpu: 2.0
          memory: 4096  # MB
      
      # 環境変数
      environment:
        NECROCODE_POOL: k8s
        NECROCODE_ENV: production
        LOG_LEVEL: INFO
      
      # ラベル
      labels:
        app: necrocode
        component: agent-runner
        pool: k8s
      
      # アノテーション
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9090"
  
  # Kubernetesスポットインスタンスプール
  # コスト効率の高いバッチ処理用
  k8s-spot:
    type: kubernetes
    max_concurrency: 20
    cpu_quota: 40
    memory_quota: 81920  # 80GB
    enabled: true
    
    config:
      namespace: necrocode-agents-spot
      job_template: manifests/runner-job-spot.yaml
      service_account: necrocode-runner
      image_pull_secrets:
        - necrocode-registry
      
      # スポットインスタンスを選択
      node_selector:
        workload: necrocode
        instance-type: spot
      
      tolerations:
        - key: spot
          operator: Equal
          value: "true"
          effect: NoSchedule
        - key: preemptible
          operator: Equal
          value: "true"
          effect: NoSchedule
      
      resources:
        requests:
          cpu: 1.0
          memory: 2048
        limits:
          cpu: 2.0
          memory: 4096
      
      environment:
        NECROCODE_POOL: k8s-spot
        NECROCODE_ENV: production
        LOG_LEVEL: INFO
      
      labels:
        app: necrocode
        component: agent-runner
        pool: k8s-spot
        instance-type: spot
      
      # スポットインスタンスの中断に対する設定
      restart_policy: OnFailure
      backoff_limit: 3

# スキルマッピング
# タスクの必要スキルとAgent Poolのマッピング
skill_mapping:
  # 開発スキル
  backend:
    - docker
    - k8s
  
  frontend:
    - docker
    - k8s
  
  database:
    - docker
  
  devops:
    - k8s
  
  # 特殊スキル
  ml:
    - docker-gpu
    - k8s
  
  ai:
    - docker-gpu
  
  data-processing:
    - k8s
    - k8s-spot
  
  # バッチ処理（スポットインスタンス優先）
  batch:
    - k8s-spot
    - k8s
  
  # テスト
  integration-test:
    - docker
  
  e2e-test:
    - docker
  
  performance-test:
    - k8s
  
  # デフォルト
  default:
    - local
    - docker

# プール選択戦略
pool_selection:
  # 負荷分散戦略: least-loaded, round-robin, random
  strategy: least-loaded
  
  # フェイルオーバーを有効化
  # プールが利用できない場合、次のプールを試す
  failover_enabled: true
  
  # プールヘルスチェック
  health_check:
    enabled: true
    interval: 30  # 秒
    timeout: 10  # 秒
    
    # 不健全なプールを自動的に無効化
    auto_disable_unhealthy: true
    
    # 再有効化の試行間隔（秒）
    re_enable_interval: 300

# プール自動スケーリング（将来の拡張用）
autoscaling:
  enabled: false
  
  # スケールアップ条件
  scale_up:
    # キューサイズがこの値を超えたらスケールアップ
    queue_threshold: 10
    
    # 使用率がこの値を超えたらスケールアップ
    utilization_threshold: 0.8
    
    # クールダウン期間（秒）
    cooldown: 300
  
  # スケールダウン条件
  scale_down:
    # 使用率がこの値を下回ったらスケールダウン
    utilization_threshold: 0.3
    
    # クールダウン期間（秒）
    cooldown: 600
  
  # 最小/最大インスタンス数
  min_instances: 1
  max_instances: 50
