# PR Service Templates

This directory contains Jinja2 templates used by the NecroCode Review & PR Service for generating pull request descriptions and comments.

## Available Templates

### Pull Request Templates

#### `pr-template.md` (Default)

The default template for pull request descriptions. Includes:
- Task ID and title
- Description
- Acceptance criteria
- Test results
- Artifacts
- Execution logs
- Custom sections

**Usage:**
```python
config = PRServiceConfig(
    template=TemplateConfig(
        template_path="templates/pr-template.md"
    )
)
```

#### `pr-template-comprehensive.md`

A comprehensive template with additional sections:
- Dependencies
- Implementation details
- Metrics (execution time, lines changed)
- Review checklist
- Deployment notes
- Screenshots/demo
- Related links

**Usage:**
```python
config = PRServiceConfig(
    template=TemplateConfig(
        template_path="templates/pr-template-comprehensive.md"
    )
)
```

### Comment Templates

#### `comment-template.md` (Default)

The default template for PR comments. Includes:
- Message
- Details (key-value pairs)
- Test results summary
- Failed tests
- Links to logs and artifacts
- Next steps

**Usage:**
```python
config = PRServiceConfig(
    template=TemplateConfig(
        comment_template_path="templates/comment-template.md"
    )
)
```

#### `comment-test-failure.md`

Specialized template for test failure comments. Includes:
- Test results table
- Failed test details with errors
- Stack traces (collapsible)
- Resources and links
- Next steps
- Tips for resolution

**Usage:**
```python
# Automatically used by post_test_failure_comment()
pr_service.post_test_failure_comment(
    pr_id="123",
    test_results={...}
)
```

#### `comment-conflict.md`

Template for merge conflict notifications. Includes:
- Conflict details
- List of conflicting files
- Resolution instructions (CLI, Web, IDE)
- Resolution checklist
- Tips and resources

**Usage:**
```python
# Automatically used when conflicts are detected
pr_service.post_conflict_comment(
    pr_id="123",
    conflict_details="..."
)
```

#### `comment-ci-success.md`

Template for CI success notifications. Includes:
- Build status table
- Test results
- Code coverage
- Next steps (auto-merge status)
- Pre-merge checklist

**Usage:**
```python
# Automatically used by CI monitor on success
# Or manually:
pr_service.post_comment(
    pr_id="123",
    message="CI passed!",
    use_template=True
)
```

## Template Variables

### Common Variables

Available in all templates:

- `message`: Main message text
- `timestamp`: Current timestamp
- `details`: Dictionary of key-value details

### PR Template Variables

Available in PR templates:

- `task_id`: Task identifier (e.g., "1.1")
- `title`: Task title
- `description`: Task description
- `state`: Task state (DONE, IN_PROGRESS, etc.)
- `created_at`: Task creation timestamp
- `acceptance_criteria`: List of acceptance criteria
- `dependencies`: List of task dependencies
- `test_results`: Formatted test results
- `artifact_links`: Formatted artifact links
- `execution_logs`: Formatted execution logs
- `execution_time`: Execution time in seconds
- `source_branch`: Source branch name
- `target_branch`: Target branch name
- `custom_sections`: Dictionary of custom sections

### Comment Template Variables

Available in comment templates:

- `test_results`: Dictionary with test statistics
  - `total`: Total number of tests
  - `passed`: Number of passed tests
  - `failed`: Number of failed tests
  - `skipped`: Number of skipped tests
  - `duration`: Test duration in seconds
  - `failed_tests`: List of failed test details
- `error_log_url`: URL to error logs
- `artifact_links`: Dictionary of artifact name to URL
- `next_steps`: List of next steps
- `ci_url`: URL to CI build
- `ci_checks`: List of CI check results
- `test_coverage`: Code coverage statistics
- `conflicting_files`: List of files with conflicts
- `conflict_details`: Detailed conflict information
- `auto_merge_enabled`: Whether auto-merge is enabled
- `approvals_received`: Number of approvals received
- `approvals_required`: Number of approvals required
- `draft_pr`: Whether PR is in draft mode

## Creating Custom Templates

### Basic Template

Create a new Jinja2 template file:

```markdown
## {{title}}

{{description}}

### Results
{{test_results}}

---
*Generated by NecroCode*
```

### Using Custom Template

```python
config = PRServiceConfig(
    template=TemplateConfig(
        template_path="templates/my-custom-template.md"
    )
)

pr_service = PRService(config)
```

### Adding Custom Data

```python
pr = pr_service.create_pr(
    task=task,
    branch_name="feature/my-feature",
    custom_data={
        "my_custom_field": "Custom value",
        "another_field": 123
    }
)
```

Access in template:
```markdown
### Custom Data
- My Field: {{my_custom_field}}
- Another: {{another_field}}
```

### Adding Custom Sections

```python
engine = pr_service.template_engine
engine.set_custom_section("Breaking Changes", "None")
engine.set_custom_section("Migration Guide", "See docs/migration.md")
```

## Template Best Practices

### 1. Use Conditional Blocks

Only show sections when data is available:

```jinja2
{% if test_results %}
### Test Results
{{test_results}}
{% endif %}
```

### 2. Provide Defaults

Use default values for optional variables:

```jinja2
{{message | default("No message provided")}}
```

### 3. Format Lists

Iterate over lists properly:

```jinja2
{% for criterion in acceptance_criteria %}
- [ ] {{criterion}}
{% endfor %}
```

### 4. Use Filters

Jinja2 provides useful filters:

```jinja2
{{description | truncate(100)}}  # Truncate to 100 chars
{{value | round(2)}}              # Round to 2 decimals
{{text | upper}}                  # Convert to uppercase
```

### 5. Add Collapsible Sections

Use HTML details for long content:

```markdown
<details>
<summary>Click to expand</summary>

{{long_content}}

</details>
```

### 6. Include Links

Make templates actionable with links:

```markdown
- [View Logs]({{log_url}})
- [CI Build]({{ci_url}})
- [Documentation](https://docs.example.com)
```

## Template Testing

Test your templates before deploying:

```python
from necrocode.review_pr_service import PRTemplateEngine, PRServiceConfig

config = PRServiceConfig(
    template=TemplateConfig(
        template_path="templates/my-template.md"
    )
)

engine = PRTemplateEngine(config)

# Test with sample data
result = engine.generate(
    task=sample_task,
    acceptance_criteria=["Criterion 1", "Criterion 2"],
    test_results={"total": 10, "passed": 10}
)

print(result)
```

## Examples

See the `examples/` directory for complete usage examples:

- `examples/pr_template_engine_example.py` - Template engine usage
- `examples/basic_pr_service_usage.py` - Basic PR creation
- `examples/github_setup.py` - GitHub configuration

## Troubleshooting

### Template Not Found

Ensure the template path is correct:

```python
import os
template_path = "templates/pr-template.md"
assert os.path.exists(template_path), f"Template not found: {template_path}"
```

### Variable Not Defined

Use conditional blocks or defaults:

```jinja2
{% if variable %}
{{variable}}
{% else %}
*Not available*
{% endif %}
```

Or:

```jinja2
{{variable | default("Not available")}}
```

### Syntax Errors

Validate template syntax:

```python
engine = PRTemplateEngine(config)
try:
    engine._load_template()
    print("✅ Template syntax is valid")
except Exception as e:
    print(f"❌ Template syntax error: {e}")
```

## Contributing

When adding new templates:

1. Follow the naming convention: `{type}-{purpose}.md`
2. Document all variables used
3. Add usage examples
4. Test with real data
5. Update this README

## See Also

- [PR Service README](../necrocode/review_pr_service/README.md)
- [Jinja2 Documentation](https://jinja.palletsprojects.com/)
- [Markdown Guide](https://www.markdownguide.org/)
